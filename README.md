# Лабораторная работа №2
## Мини-оболочка с файловыми командами

**Студент:** Ларьков Андрей Александрович
**Группа:** М8О-103БВ-25

---

## Описание проекта

Лабораторная работа представляет собой реализацию мини-оболочки на языке Python,
обеспечивающей интерактивный ввод команд, аналогичный UNIX-оболочкам (`bash`, `zsh`)

---

## Основной функционал

| Команда | Описание | Флаги / Особенности                                                                                                                                                                   |
|----------|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **pwd** | Отображает текущую директорию | -                                                                                                                                                                                     |
| **ls** | Просмотр файлов в директории | `-l` — подробный вывод; `-a` — скрытые файлы; `-la` — комбинированный режим                                                                                                           |
| **cd** | Переход в указанную директорию | Поддерживается `~`, `..`                                                                                                                                                              |
| **cat** | Просмотр содержимого файла | -                                                                                                                                                                                     |
| **cp** | Копирование файла или директории | `-r` - рекурсивное копирование; поддерживается мульти-копирование (несколько файлов в одну директорию)                                                                                |
| **mv** | Перемещение файлов или директорий | При совпадении пути - перезапись                                                                                                                                                      |
| **rm** | Удаление файлов или директорий | `-r` - удаление директорий; `-f` — без подтверждения; `-rf` - комбинированный режим                                                                                                   |
| **history** | Просмотр истории команд | При `undo` команда удаляется из истории; при вводе `history n` можно увидеть последние n команд из истории                                                                            |
| **undo** | Отмена последней операции (`cp`, `rm`, `mv`) | Для отмены `rm` существует корзина `src/.trash`, куда перемещается файл, а в истории также хранится путь к файлу в корзине с уникальным номером<br/>для предотвращения коллизии имен. |
| **zip**, **unzip** | Архивация и распаковка файлов в формате `.zip` | -                                                                                                                                                                                     |
| **tar**, **untar** | Архивация и распаковка `.tar.gz` архивов | -                                                                                                                                                                                     |
| **grep** | Поиск текста по шаблону в файлах и директориях | Поддерживаются регулярные выражения; `-r` для рекурсивного поиска; `-i` для игнорирования регистра                                                                                    |

---

## Архитектура проекта

Проект построен по модульному принципу. Каждый компонент изолирован и отвечает за определённый аспект работы оболочки.

- **`errors/shell_errors.py`** — содержит класс `ShellError`, используемый для обработки ошибок внутри всех команд.

- **`src/commands/`** — основной модуль с реализацией всех команд оболочки:
  - **`filesystem.py`** — операции с файловой системой (`cp`, `mv`, `rm`);
  - **`grep.py`** — реализация поиска по шаблону с использованием регулярных выражений;
  - **`info.py`** — команды для вывода информации о файловой системе (`ls`, `pwd`);
  - **`undo.py`** — реализация механизма отмены команд;
  - **`viewer.py`** — команды для просмотра информации (`cat`, `history`, `cd`);
  - **`zip_archives.py`** и **`tar_archives.py`** — работа с архивами в форматах `zip` и `tar.gz`.

- **`src/utils/helpers.py`** — набор вспомогательных функций: нормализация путей, проверка существования, перемещение удалённых объектов в `src/.trash` с уникальным именем.

- **`main.py`** — главный исполняемый модуль. Реализует цикл команд, парсинг пользовательского ввода, вызов нужных функций и логирование.

- **`history.py`** — модуль для записи и чтения истории выполненных операций.

- **`constants.py`** — содержит глобальные константы (пути к служебным каталогам).

---

## Логика работы оболочки

1. При запуске `main.py` создаётся интерактивный цикл, отображающий приглашение вида: *user@host:~/directory$*
2. Введённая пользователем команда разбирается при помощи модуля `shlex`, после чего вызывается соответствующая функция из словаря команд.
3. Все основные ошибки перехватываются и оформляются через класс `ShellError`.
4. Информация о каждой успешно выполненной команде записывается в `src/shell.log` и `src/.history`, что позволяет реализовать откат действий при помощи команды `undo`.

---

## Хранение истории

История хранится в текстовом файле в формате JSON, где каждая строка соответствует выполненной команде.
Пример записи: *{"cmd": "cp", "user_input": "cp file.txt test_dir", "number": 12}*
## Тестирование

Проект полностью покрыт тестами с использованием `pytest`, `unittest`.

Особенности тестов:
- Используются фикстуры для создания временных директорий (`temp_dir`) и очистки после теста.
- Функции, записывающие историю (`create_history_record`), замоканы, чтобы не изменять реальный файл истории пользователя.
- Проверяются все команды оболочки:
  - Файловые операции (`cp`, `mv`, `rm`) с флагами и рекурсивным копированием;
  - Просмотр файлов и директорий (`cat`, `ls`, `pwd`, `cd`);
  - Undo последней операции (`undo`);
  - Архивация и распаковка (`zip`, `tar.gz`);
  - История команд и ограничение количества выводимых записей.
- Используется `capsys` для проверки вывода команд в stdout.
- Тесты изолированы и не влияют на реальную файловую систему или историю пользователя.

Запуск тестов:
```bash
pytest -v --maxfail=1 --disable-warnings
```
---
## Работа с проектом
1) Склонировать репозиторий
2) Создать виртуальное окружение и активировать его
```bash
python3 -m venv venv
source venv/bin/activate #Для Windows: venv\Scripts\activate
```
3) Установить зависимости
```bash
pip install -r requirements.txt
```
4) Запустить оболочку
```bash
python3 -m src.main
```
